<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artist Printing - Master Quote Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Animation & Transition Classes */
        #historyDrawer { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .drawer-open { transform: translateX(0); }
        .drawer-closed { transform: translateX(-100%); }
        
        /* ERROR ANIMATION */
        .error-shake { 
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; 
            border: 2px solid #ef4444 !important; 
            background-color: #fef2f2 !important; 
        }
        
        @keyframes shake { 
            10%, 90% { transform: translate3d(-1px, 0, 0); } 
            20%, 80% { transform: translate3d(2px, 0, 0); } 
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 
            40%, 60% { transform: translate3d(4px, 0, 0); } 
        }
        
        .engine-locked { display: none; }
        .no-scroll { overflow: hidden; height: 100vh; }

        /* Hide number spinner arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-slate-900 no-scroll">

<div id="historyDrawer" class="fixed top-0 left-0 h-full w-80 md:w-96 bg-[#0f172a] text-white z-50 p-6 shadow-2xl drawer-closed border-r border-blue-900/30">
    <div class="flex justify-between items-center mb-6 border-b border-slate-800 pb-4">
        <div>
            <h2 class="text-xl font-bold uppercase tracking-widest text-blue-400 text-sm italic leading-none">Quotation History</h2>
            <span id="syncStatus" class="text-[8px] uppercase tracking-widest text-slate-500">Connecting...</span>
        </div>
        <button onclick="toggleHistory()" class="text-slate-500 hover:text-white text-3xl">&times;</button>
    </div>
    <div id="historyList" class="space-y-4 overflow-y-auto h-[85%] pr-2">
    </div>
</div>

<section id="homeSection" class="h-screen w-full flex flex-col justify-center items-center p-6 relative bg-gray-100">
    <button onclick="toggleHistory()" class="absolute top-10 left-10 w-14 h-14 bg-white border-2 border-gray-100 rounded-full flex items-center justify-center hover:border-blue-500 transition-all shadow-sm z-10">
        <span class="text-2xl">üïí</span>
    </button>

    <div class="max-w-md w-full bg-white p-12 rounded-[40px] shadow-2xl border border-gray-200 space-y-10">
        <div class="flex flex-col items-center gap-4">
            <div class="h-20 w-full flex items-center justify-center">
                 <img src="Artist logo.png" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'" alt="Artist Printing Logo" class="h-20 w-auto object-contain">
                 <h2 class="hidden text-3xl">üé®</h2>
            </div>
            <div class="text-center border-b-4 border-slate-900 pb-2 px-6">
                <h1 class="text-2xl font-black text-slate-900 uppercase italic tracking-tighter">Artist <span class="text-blue-600">Printing</span></h1>
            </div>
        </div>

        <div class="space-y-6">
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Staff Member <span class="text-red-500">*</span></label>
                <select id="homeStaff" class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl outline-none font-semibold focus:border-blue-500 appearance-none transition-all cursor-pointer">
                    <option value="" selected disabled>Select Name...</option>
                    <option value="Kaushik">Kaushik</option>
                    <option value="Harshal">Harshal</option>
                    <option value="Purva">Purva</option>
                    <option value="Canny">Canny</option>
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Customer / Company <span class="text-red-500">*</span></label>
                <input type="text" id="homeCustomer" placeholder="Enter name..." class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl outline-none focus:border-blue-500 transition-all">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Work Type <span class="text-red-500">*</span></label>
                <select id="homeWorkType" class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl outline-none font-bold focus:border-blue-500 appearance-none transition-all cursor-pointer">
                    <option value="" selected disabled>Select Type...</option>
                    <option value="vinyl">Banners / Vinyl Printing</option>
                </select>
            </div>
        </div>

        <button onclick="unlockAndScroll()" class="w-full py-6 rounded-full border-4 border-slate-900 text-slate-900 text-xl font-black uppercase tracking-widest hover:bg-slate-900 hover:text-white transition-all active:scale-95 shadow-lg">
            Start Quote ‚Üì
        </button>
    </div>
</section>

<section id="quoteSection" class="engine-locked min-h-screen p-6 md:p-10 flex flex-col justify-center bg-gray-50/50 border-t-2 border-gray-200">
    <div class="max-w-5xl mx-auto w-full">
        <div class="flex items-center justify-between mb-8 px-4">
            <button onclick="lockAndReturn()" class="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase tracking-widest transition-all">‚Üë Change Details</button>
            <div class="flex items-center gap-2">
                <img src="Artist logo.png" alt="Artist Printing Logo" class="h-5 w-auto object-contain">
                <h2 class="text-xs font-black text-blue-600 uppercase tracking-widest italic font-bold">Quotation Engine</h2>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="flex-1 bg-white p-10 rounded-[40px] shadow-2xl border border-gray-200 space-y-6">
                <input type="hidden" id="activeStaff"><input type="hidden" id="activeCustomer">
                
                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Material Category</label>
                        <select id="material" onchange="updateTypes()" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none focus:border-blue-500 transition-all cursor-pointer">
                            <option value="" selected disabled>Select Category...</option>
                            <option value="Vinyl">Vinyl Printing</option>
                            <option value="Banners">Banners (Roll)</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Type Option <span class="text-red-500">*</span></label>
                        <select id="materialType" disabled class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none focus:border-blue-500 cursor-pointer disabled:opacity-50 transition-all">
                            <option value="" selected disabled>Select material first</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-end gap-4">
                    <div class="flex-1 space-y-1">
                        <label class="text-[10px] font-bold text-blue-600 uppercase ml-1 font-bold">Input Height Value <span class="text-red-500">*</span></label>
                        <input type="number" id="height" min="0" step="0.01" oninput="validity.valid||(value='');" class="w-full p-4 bg-gray-50 border-2 border-blue-50 rounded-2xl outline-none focus:border-blue-500 transition-all" placeholder="0.00">
                    </div>
                    <div class="w-32 space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Units</label>
                        <select id="units" class="w-full p-4 bg-white border-2 border-blue-500 rounded-2xl font-bold text-blue-600 outline-none cursor-pointer">
                            <option value="mm">MM</option><option value="cm">CM</option><option value="m">M</option><option value="ft" selected>FT</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Pricing Range <span class="text-red-500">*</span></label>
                    <select id="range" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none font-bold focus:border-blue-500 cursor-pointer transition-all">
                        <option value="" selected disabled>Please select price range</option>
                        <option value="High">High Range</option>
                        <option value="Medium">Medium Range</option>
                        <option value="Low">Low Range</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4 pt-4">
                    <button onclick="calculateQuote()" class="bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-2xl shadow-xl uppercase text-xs tracking-widest transition-all active:scale-95">Calculate</button>
                    <button onclick="softReset()" class="bg-gray-100 hover:bg-gray-200 text-slate-500 font-bold py-5 rounded-2xl uppercase text-xs tracking-widest">Clear</button>
                </div>
            </div>

            <div class="w-full lg:w-96 bg-[#0f172a] text-white p-10 rounded-[45px] shadow-2xl flex flex-col border border-slate-800 min-h-[550px]">
                <div id="placeholder" class="text-center h-full flex flex-col justify-center opacity-20 italic text-sm">
                    <p>Enter measurements for summary</p>
                </div>
                
                <div id="quoteResult" class="hidden h-full flex flex-col">
                    <div class="border-b border-slate-800 pb-6 mb-8 text-center">
                        <p class="text-[10px] text-blue-400 font-black uppercase mb-1 tracking-[0.2em]">Active Quote</p>
                        <h2 id="resCustomer" class="text-3xl font-black truncate uppercase tracking-tighter">---</h2>
                        <p class="text-[10px] text-slate-500 font-bold uppercase mt-1 tracking-widest">By: <span id="resStaff">---</span></p>
                    </div>
                    
                    <div class="space-y-6 flex-grow text-xs">
                        <div class="bg-slate-900/50 p-5 rounded-2xl border border-slate-800 flex justify-between items-center shadow-inner">
                            <div><p class="text-[9px] text-slate-500 font-bold uppercase mb-1">Roll</p><p id="resRoll" class="text-xs font-bold text-white uppercase tracking-wider">---</p></div>
                            <div class="text-right"><p class="text-[9px] text-slate-500 font-bold uppercase mb-1">Width</p><p id="resWidth" class="text-sm font-black text-blue-400">--</p></div>
                        </div>
                        <div class="bg-slate-900/50 p-5 rounded-2xl border border-slate-800 flex justify-between items-center shadow-inner">
                            <div><p class="text-[9px] text-slate-500 font-bold uppercase mb-1">Inputted</p><p id="resInput" class="text-xs font-bold text-slate-400">--</p></div>
                            <div class="text-right"><p class="text-[9px] text-green-600 font-bold uppercase mb-1">Rounded</p><p id="resRounded" class="text-sm font-black text-green-400 font-mono">--</p></div>
                        </div>
                        <div class="mt-12 pt-10 border-t border-slate-800">
                            <p class="text-[10px] text-slate-500 font-black uppercase tracking-[0.2em] mb-2">Total Amount</p>
                            <div id="resTotal" class="text-6xl font-black text-blue-400 tracking-tighter italic">¬£0.00</div>
                        </div>
                    </div>
                    
                    <button onclick="window.print()" class="mt-12 w-full bg-white hover:bg-gray-100 text-slate-900 py-6 rounded-2xl font-black uppercase tracking-widest shadow-2xl active:scale-95 transition-all">Print Receipt</button>
                    <p id="saveStatus" class="text-[9px] text-center mt-2 text-slate-600 uppercase tracking-widest opacity-0 transition-opacity">Saving to cloud...</p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// --- CONFIGURATION ---
const SUPABASE_URL = 'https://qenxaqprgrbrapsuqfch.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlbnhhcXByZ3JicmFwc3VxZmNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2Nzg5ODksImV4cCI6MjA4MjI1NDk4OX0.P4faPhpEHfu3Rzq4aiNJ8HjIvupJAu7rnQAdhXVs3Ng';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const materialData = {
    "Vinyl": {
        "mono 1370": { widthFt: 4.5, prices: { High: 42.75, Medium: 28.50, Low: 24.23 } },
        "mono maric 1050": { widthFt: 3.5, prices: { High: 42.51, Medium: 28.34, Low: 24.09 } },
        "mono 1600": { widthFt: 5.0, prices: { High: 44.10, Medium: 29.40, Low: 24.99 } },
        "POLYMERIC Vinyl 7 YEAR": { widthFt: 4.5, prices: { High: 50.86, Medium: 33.90, Low: 28.82 } }
    },
    "Banners": {
        "FLEX BANNER": { widthFt: 4.5, prices: { High: 42.31, Medium: 28.21, Low: 23.98 } },
        "flex banner 1.6M": { widthFt: 5.0, prices: { High: 44.16, Medium: 29.44, Low: 25.03 } },
        "Premium 440gsm PVC Banner": { widthFt: 3.5, prices: { High: 41.80, Medium: 27.87, Low: 23.69 } }
    }
};

// --- CORE FUNCTIONS ---

async function syncCloud() {
    const statusEl = document.getElementById('syncStatus');
    try {
        const { data, error } = await _supabase
            .from('quote_history') 
            .select('*')
            .order('created_at', { ascending: false })
            .limit(20);
        if (error) throw error;
        
        // Cache to local storage
        localStorage.setItem('artist_printing_history', JSON.stringify(data));
        renderHistory(data);
        statusEl.innerText = "History Synced ‚úÖ";
        statusEl.classList.remove('text-red-500');
        statusEl.classList.add('text-slate-500');
    } catch (e) {
        console.warn("Offline or API Error", e);
        statusEl.innerText = "Offline Mode ‚ö†Ô∏è";
        statusEl.classList.add('text-red-500');
    }
}

function renderHistory(data) {
    const list = document.getElementById('historyList');
    if (!data || data.length === 0) {
        list.innerHTML = '<div class="text-center text-slate-600 py-10">No history yet</div>';
        return;
    }
    
    list.innerHTML = data.map(q => {
        const dateObj = new Date(q.created_at);
        const dateStr = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        return `
        <div class="bg-[#1e293b] p-6 rounded-3xl border-l-4 border-blue-500 mb-4 shadow-xl text-[10px] hover:bg-[#253247] transition-colors relative">
            
            <div class="absolute top-6 right-6 bg-blue-900 text-blue-200 px-2 py-1 rounded text-[9px] font-bold uppercase tracking-wider border border-blue-700">
                ${q.category || 'General'}
            </div>

            <div class="flex justify-between items-center text-slate-500 mb-2 border-b border-slate-700 pb-2 uppercase tracking-widest w-2/3">
                <span class="font-bold text-slate-400">${q.staff}</span>
                <span>${dateStr} - ${timeStr}</span>
            </div>
            
            <div class="text-white font-black text-xs uppercase mb-1 truncate w-3/4">${q.customer}</div>
            
            <div class="grid grid-cols-2 gap-y-1 text-slate-400 uppercase tracking-tighter mt-2">
                <span class="truncate pr-2 col-span-2 text-slate-300">Item: ${q.type}</span>
                <span class="text-blue-400 font-bold col-span-2 mb-1">Range: ${q.range || 'Standard'}</span>
                <span class="text-slate-500">Raw: ${q.original || 'N/A'}</span>
                <span class="text-green-500 font-bold border-t border-slate-700 pt-1 mt-1">Final: ${q.details}</span>
            </div>
            
            <div class="mt-3 text-right text-blue-400 font-black text-2xl italic leading-none">¬£${q.price}</div>
        </div>
    `}).join('');
}

// --- UI NAVIGATION ---

function toggleHistory() { 
    const drawer = document.getElementById('historyDrawer');
    if(drawer.classList.contains('drawer-closed')) {
        drawer.classList.remove('drawer-closed');
        drawer.classList.add('drawer-open');
        syncCloud(); // Try to sync when opening
    } else {
        drawer.classList.remove('drawer-open');
        drawer.classList.add('drawer-closed');
    }
}

function unlockAndScroll() {
    const s = document.getElementById('homeStaff');
    const c = document.getElementById('homeCustomer');
    const w = document.getElementById('homeWorkType');
    
    let hasError = false;
    [s, c, w].forEach(field => { 
        if(!field.value || field.value.trim() === "") { 
            field.classList.add('error-shake'); 
            hasError = true; 
        } else { 
            field.classList.remove('error-shake'); 
        }
    });
    
    // Remove shake animation class after it plays so it can be triggered again
    if(hasError) {
        setTimeout(() => {
            [s, c, w].forEach(f => f.classList.remove('error-shake'));
        }, 500);
        return;
    }

    document.getElementById('activeStaff').value = s.value;
    document.getElementById('activeCustomer').value = c.value;
    
    document.body.classList.remove('no-scroll');
    document.getElementById('quoteSection').classList.remove('engine-locked');
    
    setTimeout(() => { 
        document.getElementById('quoteSection').scrollIntoView({ behavior: 'smooth' }); 
    }, 100);
}

function lockAndReturn() { 
    window.scrollTo({ top: 0, behavior: 'smooth' }); 
    setTimeout(() => { 
        document.body.classList.add('no-scroll'); 
        document.getElementById('quoteSection').classList.add('engine-locked'); 
    }, 600); 
}

function updateTypes() {
    const mat = document.getElementById('material').value;
    const t = document.getElementById('materialType'); 
    
    t.innerHTML = '<option value="" selected disabled>Choose Type...</option>'; 
    t.disabled = false;
    t.classList.remove('disabled:opacity-50');
    
    if(materialData[mat]) {
        Object.keys(materialData[mat]).forEach(k => { 
            const opt = document.createElement("option"); 
            opt.value = k; 
            opt.textContent = `${k.toUpperCase()} (${materialData[mat][k].widthFt} FT)`; 
            t.appendChild(opt); 
        });
    }
}

function softReset() { 
    document.getElementById('height').value = ''; 
    document.getElementById('quoteResult').classList.add('hidden'); 
    document.getElementById('placeholder').classList.remove('hidden');
    const rangeSelect = document.getElementById('range');
    rangeSelect.value = '';
    rangeSelect.disabled = false;
    
    // Clear any stuck error states
    ['materialType', 'height', 'range'].forEach(id => {
        document.getElementById(id).classList.remove('error-shake');
    });
}

// --- CALCULATION LOGIC ---

async function calculateQuote() {
    // 1. Get DOM elements
    const els = { 
        mat: document.getElementById('material'), 
        type: document.getElementById('materialType'), 
        h: document.getElementById('height'), 
        u: document.getElementById('units'), 
        r: document.getElementById('range') 
    };

    // 2. VALIDATION (Replaces Alert with Red Shake)
    let hasError = false;

    // Check Type
    if(!els.type.value) {
        els.type.classList.add('error-shake');
        hasError = true;
    } else {
        els.type.classList.remove('error-shake');
    }

    // Check Height
    if(!els.h.value || parseFloat(els.h.value) <= 0) {
        els.h.classList.add('error-shake');
        hasError = true;
    } else {
        els.h.classList.remove('error-shake');
    }

    // Check Range
    if(!els.r.value) {
        els.r.classList.add('error-shake');
        hasError = true;
    } else {
        els.r.classList.remove('error-shake');
    }

    // Stop if errors exist
    if(hasError) {
        // Remove the shake class after 500ms so it can trigger again on next click
        setTimeout(() => {
            [els.type, els.h, els.r].forEach(el => el.classList.remove('error-shake'));
        }, 500);
        return; 
    }

    // 3. Calculation
    const hIn = parseFloat(els.h.value);
    const unit = els.u.value;
    
    // Convert to meters
    let hM = hIn;
    if (unit === 'ft') hM = hIn * 0.3048;
    else if (unit === 'cm') hM = hIn / 100;
    else if (unit === 'mm') hM = hIn / 1000;
    
    // Rounding Logic: Min 1m, then nearest 0.5m
    let roundedM = hM <= 1 ? 1 : Math.ceil(hM * 2) / 2;
    
    // Convert back for display
    let backConv;
    if (unit === 'mm') backConv = (roundedM * 1000).toFixed(0);
    else if (unit === 'cm') backConv = (roundedM * 100).toFixed(0);
    else if (unit === 'ft') backConv = (roundedM / 0.3048).toFixed(1);
    else backConv = roundedM.toFixed(1);
    
    // Price Calc
    const price = (roundedM * materialData[els.mat.value][els.type.value].prices[els.r.value]).toFixed(2);
    const details = `${roundedM.toFixed(1)} m (${backConv} ${unit})`;

    // 4. Update UI
    document.getElementById('placeholder').classList.add('hidden');
    document.getElementById('quoteResult').classList.remove('hidden');
    
    document.getElementById('resCustomer').innerText = document.getElementById('activeCustomer').value;
    document.getElementById('resStaff').innerText = document.getElementById('activeStaff').value;
    document.getElementById('resRoll').innerText = els.type.value;
    document.getElementById('resWidth').innerText = materialData[els.mat.value][els.type.value].widthFt + " ft";
    document.getElementById('resInput').innerText = `${hIn} ${unit}`;
    document.getElementById('resRounded').innerText = details;
    document.getElementById('resTotal').innerText = `¬£${price}`;

    // Disable range selection after calculation
    els.r.disabled = true;

    // 5. Save to Supabase with Error Handling
    const saveStatus = document.getElementById('saveStatus');
    saveStatus.innerText = "Saving to cloud...";
    saveStatus.classList.remove('opacity-0', 'text-green-500', 'text-red-500');
    saveStatus.classList.add('text-slate-600');
    
    try {
        const { error } = await _supabase.from('quote_history').insert([{ 
            staff: document.getElementById('activeStaff').value, 
            customer: document.getElementById('activeCustomer').value, 
            price: price, 
            details: details, 
            original: `${hIn} ${unit}`, 
            type: els.type.value, 
            range: els.r.value,
            category: els.mat.value
        }]);

        if (error) throw error;
        
        saveStatus.innerText = "Quote Saved Successfully ‚úÖ";
        saveStatus.classList.remove('text-slate-600');
        saveStatus.classList.add('text-green-500');
        syncCloud(); // Update the sidebar
    } catch (err) {
        console.error("Save Error:", err);
        saveStatus.innerText = "Offline - Saved Locally Only ‚ö†Ô∏è";
        saveStatus.classList.remove('text-slate-600');
        saveStatus.classList.add('text-red-500');
    }
}

// --- INITIALIZATION ---
window.onload = () => {
    window.scrollTo(0,0);
    const local = localStorage.getItem('artist_printing_history');
    if (local) renderHistory(JSON.parse(local));
    syncCloud();
};
</script>
</body>
</html>